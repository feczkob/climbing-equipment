<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Climbing stuff discounts by category</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        h2 { margin-top: 2em; }
        .product { margin-bottom: 1em; border-bottom: 1px solid #eee; padding-bottom: 1em; display: flex; align-items: flex-start; }
        .product-img { margin-right: 1em; }
        .product-img img { max-width: 90px; max-height: 90px; border-radius: 6px; background: #f8f8f8; }
        .product-details { flex: 1; }
        .product-name { font-weight: bold; font-size: 1.1em; }
        .discount-percent { color: #388e3c; font-weight: bold; margin-left: 0.5em; }
        .orig-price { text-decoration: line-through; color: #888; margin-right: 1em; }
        .disc-price { color: #d32f2f; font-weight: bold; }
        .shop { color: #0074d9; margin-top: 0.3em; }
        #category-select { font-size: 1.1em; margin-bottom: 2em; }
    </style>
</head>
<body>
    <h1>Climbing stuff discounts</h1>
    <label for="category-select"><b>Select category:</b></label>
    <select name="category" id="category-select">
      {% for category in categories %}
        <option value="{{ category }}">{{ category.capitalize() }}</option>
      {% endfor %}
    </select>
    <div id="discounts-container"></div>
    <script>
    const container = document.getElementById('discounts-container');
    const select = document.getElementById('category-select');

    function parseProductInfo(productStr) {
        const lines = productStr.split('\n');
        return {
            name: lines[0].split(' -')[0].trim(),
            orig: lines[1].split(' ')[0].trim(),
            disc: lines[1].split(' ')[1].trim(),
            shop: lines[2] || ''
        };
    }

    async function renderProducts(category) {
        container.innerHTML = '<p>Loading...</p>';
        try {
            const resp = await fetch(`/discounts/${category}`);
            if (!resp.ok) {
                container.innerHTML = '<p>No discounts found.</p>';
                return;
            }
            const discounts = await resp.json();
            if (discounts.length === 0) {
                container.innerHTML = '<p>No discounts found.</p>';
                return;
            }
            container.innerHTML = '';
            discounts.forEach(d => {
                const info = parseProductInfo(d.product);
                const div = document.createElement('div');
                div.className = 'product';
                div.innerHTML = `
                    <div class="product-img">
                        <a href="${d.url}" target="_blank">
                            <img src="${d.image_url || ''}" alt="${info.name}">
                        </a>
                    </div>
                    <div class="product-details">
                        <div class="product-name">
                            <a href="${d.url}" target="_blank">${info.name}</a>
                            <span class="discount-percent">${d.discountPercent}</span>
                        </div>
                        <div>
                            <span class="orig-price">${d.originalPrice}</span>
                            <span class="disc-price">${d.discountedPrice}</span>
                        </div>
                        <div class="shop">${info.shop}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        } catch (e) {
            console.error('asd', e)
            container.innerHTML = '<p>Error loading discounts.</p>';
        }
    }

    renderProducts(select.value);
    select.addEventListener('change', function() {
        renderProducts(this.value);
    });
    </script>
</body>
</html>